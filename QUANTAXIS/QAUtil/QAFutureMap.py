import datetime
import os
import copy

import jqdatasdk as jq

#jq.auth('YOUR name','Your pswd') #使用前先获得jq授权
from QUANTAXIS.QAUtil import QA_util_get_trade_range

future_map = {'SR': [['SR1505', 'SR1509', 'SR1601', 'SR1605', 'SR1609', 'SR1701', 'SR1705', 'SR1709', 'SR1801', 'SR1805', 'SR1809', 'SR1901', 'SR1905', 'SR1909', 'SR2001', 'SR2005'], ['2015-01-05', '2015-02-17', '2015-06-24', '2015-11-18', '2016-03-02', '2016-07-21', '2016-12-08', '2017-04-05', '2017-07-18', '2017-12-15', '2018-04-02', '2018-07-31', '2018-11-13', '2019-03-20', '2019-07-29', '2019-12-04']], 'I': [['I1505', 'I1509', 'I1601', 'I1605', 'I1609', 'I1701', 'I1705', 'I1709', 'I1801', 'I1805', 'I1809', 'I1901', 'I1905', 'I1909', 'I2001', 'I2005'], ['2015-01-05', '2015-03-10', '2015-07-22', '2015-11-24', '2016-03-22', '2016-08-12', '2016-11-28', '2017-03-23', '2017-08-02', '2017-11-24', '2018-04-09', '2018-08-08', '2018-12-03', '2019-04-09', '2019-08-01', '2019-12-09']], 'M': [['M1505', 'M1509', 'M1601', 'M1605', 'M1609', 'M1701', 'M1705', 'M1709', 'M1801', 'M1805', 'M1809', 'M1901', 'M1905', 'M1909', 'M2001', 'M2005'], ['2015-01-05', '2015-03-02', '2015-07-24', '2015-11-24', '2016-03-04', '2016-07-18', '2016-11-15', '2017-03-17', '2017-07-27', '2017-11-23', '2018-03-16', '2018-07-03', '2018-11-28', '2019-04-01', '2019-08-06', '2019-11-04']], 'P': [['P1505', 'P1509', 'P1601', 'P1605', 'P1609', 'P1701', 'P1705', 'P1709', 'P1801', 'P1805', 'P1809', 'P1901', 'P1905', 'P1909', 'P2001', 'P2005'], ['2015-01-05', '2015-03-06', '2015-06-05', '2015-11-30', '2016-03-16', '2016-07-07', '2016-11-24', '2017-03-10', '2017-07-06', '2017-11-21', '2018-03-22', '2018-07-23', '2018-12-04', '2019-04-11', '2019-08-06', '2019-11-28']], 'PP': [['PP1505', 'PP1509', 'PP1601', 'PP1605', 'PP1609', 'PP1701', 'PP1705', 'PP1709', 'PP1801', 'PP1805', 'PP1809', 'PP1901', 'PP1905', 'PP1909', 'PP2001', 'PP2005'], ['2015-01-05', '2015-03-19', '2015-08-05', '2015-11-26', '2016-03-29', '2016-08-12', '2016-12-02', '2017-04-12', '2017-08-10', '2017-12-04', '2018-04-10', '2018-08-08', '2018-12-07', '2019-04-09', '2019-08-02', '2019-12-09']], 'RR': [['', 'RR2001', 'RR2005'], ['2015-01-05', '2019-08-19', '2019-12-16']], 'V': [['V1505', 'V1509', 'V1601', 'V1605', 'V1609', 'V1701', 'V1705', 'V1709', 'V1801', 'V1805', 'V1809', 'V1901', 'V1905', 'V1909', 'V2001', 'V2005'], ['2015-01-05', '2015-03-30', '2015-08-13', '2015-10-20', '2016-03-28', '2016-08-19', '2016-12-05', '2017-04-10', '2017-08-10', '2017-11-30', '2018-04-10', '2018-08-09', '2018-12-04', '2019-03-26', '2019-08-14', '2019-12-11']], 'Y': [['Y1505', 'Y1509', 'Y1601', 'Y1605', 'Y1609', 'Y1701', 'Y1705', 'Y1709', 'Y1801', 'Y1805', 'Y1809', 'Y1901', 'Y1905', 'Y1909', 'Y2001', 'Y2005'], ['2015-01-05', '2015-03-05', '2015-06-17', '2015-11-18', '2016-03-09', '2016-07-07', '2016-11-24', '2017-03-22', '2017-07-28', '2017-12-04', '2018-03-27', '2018-07-27', '2018-12-04', '2019-04-03', '2019-08-02', '2019-11-22']], 'AG': [['AG1506', 'AG1512', 'AG1606', 'AG1612', 'AG1706', 'AG1712', 'AG1806', 'AG1812', 'AG1906', 'AG1912', 'AG2002', 'AG2006'], ['2015-01-05', '2015-05-08', '2015-11-18', '2016-05-10', '2016-11-14', '2017-05-11', '2017-11-22', '2018-05-04', '2018-11-05', '2019-05-09', '2019-11-14', '2019-12-26']], 'AU': [['AU1506', 'AU1512', 'AU1606', 'AU1612', 'AU1706', 'AU1712', 'AU1806', 'AU1812', 'AU1906', 'AU1912', 'AU2006'], ['2015-01-05', '2015-05-08', '2015-11-12', '2016-05-05', '2016-11-10', '2017-05-03', '2017-11-13', '2018-05-04', '2018-11-09', '2019-05-07', '2019-11-14']], 'CU': [['CU1503', 'CU1504', 'CU1505', 'CU1506', 'CU1507', 'CU1508', 'CU1509', 'CU1510', 'CU1511', 'CU1512', 'CU1601', 'CU1602', 'CU1603', 'CU1604', 'CU1605', 'CU1606', 'CU1607', 'CU1608', 'CU1609', 'CU1610', 'CU1611', 'CU1612', 'CU1701', 'CU1702', 'CU1703', 'CU1704', 'CU1705', 'CU1706', 'CU1707', 'CU1708', 'CU1709', 'CU1710', 'CU1711', 'CU1712', 'CU1801', 'CU1802', 'CU1803', 'CU1804', 'CU1805', 'CU1806', 'CU1807', 'CU1808', 'CU1809', 'CU1810', 'CU1811', 'CU1812', 'CU1901', 'CU1902', 'CU1903', 'CU1904', 'CU1905', 'CU1906', 'CU1907', 'CU1908', 'CU1909', 'CU1910', 'CU1911', 'CU1912', 'CU2001', 'CU2002', 'CU2003'], ['2015-01-05', '2015-01-26', '2015-02-26', '2015-03-25', '2015-04-28', '2015-05-28', '2015-06-30', '2015-07-28', '2015-08-28', '2015-09-29', '2015-11-02', '2015-11-27', '2015-12-30', '2016-02-02', '2016-03-01', '2016-03-30', '2016-04-27', '2016-05-30', '2016-06-29', '2016-08-02', '2016-09-05', '2016-09-29', '2016-11-02', '2016-11-29', '2016-12-29', '2017-02-10', '2017-03-09', '2017-04-13', '2017-05-10', '2017-06-02', '2017-07-04', '2017-08-02', '2017-09-07', '2017-10-09', '2017-11-08', '2017-12-04', '2017-12-29', '2018-02-05', '2018-03-02', '2018-04-16', '2018-05-07', '2018-06-08', '2018-07-10', '2018-08-10', '2018-09-05', '2018-10-23', '2018-11-05', '2018-12-03', '2019-01-04', '2019-02-18', '2019-03-07', '2019-04-19', '2019-05-13', '2019-06-13', '2019-07-09', '2019-08-09', '2019-09-09', '2019-10-10', '2019-11-14', '2019-12-11', '2020-01-06']], 'HC': [['HC1505', 'HC1510', 'HC1601', 'HC1605', 'HC1610', 'HC1701', 'HC1705', 'HC1710', 'HC1801', 'HC1805', 'HC1810', 'HC1901', 'HC1905', 'HC1910', 'HC2001', 'HC2005'], ['2015-01-05', '2015-04-09', '2015-07-29', '2015-12-02', '2016-04-14', '2016-09-02', '2016-12-01', '2017-03-29', '2017-08-11', '2017-11-28', '2018-04-10', '2018-08-21', '2018-11-29', '2019-04-10', '2019-08-28', '2019-12-16']], 'NI': [['', 'NI1507', 'NI1509', 'NI1601', 'NI1605', 'NI1609', 'NI1701', 'NI1705', 'NI1709', 'NI1801', 'NI1805', 'NI1807', 'NI1809', 'NI1811', 'NI1901', 'NI1905', 'NI1906', 'NI1907', 'NI1908', 'NI1909', 'NI1910', 'NI1911', 'NI1912', 'NI2001', 'NI2002', 'NI2003'], ['2015-01-05', '2015-03-30', '2015-05-29', '2015-08-17', '2015-12-16', '2016-04-11', '2016-08-02', '2016-11-28', '2017-04-06', '2017-08-04', '2017-11-14', '2018-03-30', '2018-06-06', '2018-08-07', '2018-10-12', '2018-12-07', '2019-04-11', '2019-05-08', '2019-06-06', '2019-07-09', '2019-07-16', '2019-09-02', '2019-10-09', '2019-11-04', '2019-11-18', '2019-12-31']], 'NR': [['', 'NR2002', 'NR2003', 'NR2004'], ['2015-01-05', '2019-08-13', '2019-11-18', '2020-01-08']], 'PB': [['PB1502', 'PB1503', 'PB1504', 'PB1505', 'PB1506', 'PB1507', 'PB1508', 'PB1509', 'PB1510', 'PB1511', 'PB1512', 'PB1601', 'PB1602', 'PB1603', 'PB1604', 'PB1605', 'PB1606', 'PB1607', 'PB1608', 'PB1609', 'PB1610', 'PB1611', 'PB1612', 'PB1701', 'PB1702', 'PB1703', 'PB1704', 'PB1705', 'PB1706', 'PB1707', 'PB1708', 'PB1709', 'PB1710', 'PB1711', 'PB1712', 'PB1801', 'PB1802', 'PB1803', 'PB1804', 'PB1805', 'PB1806', 'PB1807', 'PB1808', 'PB1809', 'PB1810', 'PB1811', 'PB1812', 'PB1901', 'PB1902', 'PB1903', 'PB1904', 'PB1905', 'PB1906', 'PB1907', 'PB1908', 'PB1909', 'PB1910', 'PB1911', 'PB1912', 'PB2001', 'PB2002', 'PB2003'], ['2015-01-05', '2015-01-06', '2015-02-03', '2015-03-06', '2015-04-01', '2015-05-08', '2015-06-03', '2015-07-10', '2015-07-22', '2015-09-08', '2015-10-12', '2015-11-11', '2015-12-04', '2016-01-13', '2016-02-18', '2016-03-09', '2016-04-15', '2016-05-10', '2016-06-15', '2016-07-08', '2016-08-23', '2016-09-21', '2016-10-21', '2016-11-09', '2016-12-09', '2017-01-17', '2017-02-22', '2017-03-17', '2017-04-18', '2017-05-24', '2017-06-23', '2017-07-24', '2017-08-17', '2017-09-19', '2017-10-23', '2017-11-17', '2017-12-21', '2018-01-18', '2018-02-22', '2018-03-15', '2018-04-18', '2018-05-23', '2018-06-27', '2018-07-24', '2018-08-21', '2018-09-20', '2018-10-23', '2018-11-16', '2018-12-20', '2019-01-23', '2019-02-22', '2019-03-20', '2019-04-17', '2019-05-23', '2019-06-24', '2019-07-17', '2019-08-22', '2019-09-19', '2019-10-24', '2019-11-18', '2019-12-18', '2020-01-14']], 'RB': [['RB1505', 'RB1510', 'RB1601', 'RB1605', 'RB1610', 'RB1701', 'RB1705', 'RB1710', 'RB1801', 'RB1805', 'RB1810', 'RB1901', 'RB1905', 'RB1910', 'RB2001', 'RB2005'], ['2015-01-05', '2015-03-10', '2015-07-21', '2015-11-05', '2016-03-15', '2016-08-19', '2016-11-29', '2017-03-24', '2017-08-09', '2017-11-10', '2018-03-29', '2018-08-20', '2018-11-29', '2019-04-02', '2019-08-23', '2019-12-06']], 'RU': [['RU1505', 'RU1509', 'RU1601', 'RU1605', 'RU1609', 'RU1701', 'RU1705', 'RU1709', 'RU1801', 'RU1805', 'RU1809', 'RU1901', 'RU1905', 'RU1909', 'RU2001', 'RU2005'], ['2015-01-05', '2015-02-26', '2015-07-17', '2015-11-25', '2016-03-18', '2016-08-04', '2016-11-22', '2017-03-27', '2017-08-03', '2017-11-29', '2018-03-30', '2018-08-09', '2018-12-03', '2019-03-25', '2019-08-09', '2019-11-28']], 'SC': [['', 'SC1809', 'SC1812', 'SC1901', 'SC1903', 'SC1904', 'SC1905', 'SC1906', 'SC1907', 'SC1908', 'SC1909', 'SC1910', 'SC1911', 'SC1912', 'SC2001', 'SC2002', 'SC2003'], ['2015-01-05', '2018-03-27', '2018-08-10', '2018-11-20', '2018-12-19', '2019-02-19', '2019-03-19', '2019-04-18', '2019-05-22', '2019-06-19', '2019-07-17', '2019-08-16', '2019-09-10', '2019-10-14', '2019-11-18', '2019-12-11', '2020-01-06']], 'SN': [['', 'SN1507', 'SN1509', 'SN1601', 'SN1605', 'SN1609', 'SN1701', 'SN1705', 'SN1709', 'SN1801', 'SN1805', 'SN1809', 'SN1901', 'SN1905', 'SN1909', 'SN2001', 'SN2005', 'SN2006'], ['2015-01-05', '2015-03-30', '2015-07-03', '2015-09-15', '2015-12-23', '2016-05-05', '2016-09-01', '2017-01-03', '2017-04-27', '2017-08-31', '2017-12-26', '2018-04-19', '2018-08-16', '2018-12-07', '2019-04-11', '2019-08-12', '2019-12-05', '2020-01-06']], 'SP': [['', 'SP1906', 'SP1909', 'SP2001', 'SP2005'], ['2015-01-05', '2018-11-28', '2019-05-07', '2019-08-12', '2019-12-13']], 'SS': [['', 'SS2002', 'SS2006'], ['2015-01-05', '2019-09-26', '2020-01-02']], 'ZN': [['ZN1503', 'ZN1504', 'ZN1505', 'ZN1506', 'ZN1507', 'ZN1508', 'ZN1509', 'ZN1510', 'ZN1511', 'ZN1512', 'ZN1601', 'ZN1602', 'ZN1603', 'ZN1604', 'ZN1605', 'ZN1606', 'ZN1607', 'ZN1608', 'ZN1609', 'ZN1610', 'ZN1611', 'ZN1612', 'ZN1701', 'ZN1702', 'ZN1703', 'ZN1704', 'ZN1705', 'ZN1706', 'ZN1707', 'ZN1708', 'ZN1709', 'ZN1710', 'ZN1711', 'ZN1712', 'ZN1801', 'ZN1802', 'ZN1803', 'ZN1804', 'ZN1805', 'ZN1806', 'ZN1807', 'ZN1808', 'ZN1809', 'ZN1810', 'ZN1811', 'ZN1812', 'ZN1901', 'ZN1902', 'ZN1903', 'ZN1904', 'ZN1905', 'ZN1906', 'ZN1907', 'ZN1908', 'ZN1909', 'ZN1910', 'ZN1911', 'ZN1912', 'ZN2001', 'ZN2002', 'ZN2003'], ['2015-01-05', '2015-01-28', '2015-02-27', '2015-03-25', '2015-04-24', '2015-05-27', '2015-06-29', '2015-07-30', '2015-09-01', '2015-09-29', '2015-11-02', '2015-11-27', '2015-12-31', '2016-02-03', '2016-03-03', '2016-03-30', '2016-05-04', '2016-06-02', '2016-07-01', '2016-08-01', '2016-09-01', '2016-10-11', '2016-11-01', '2016-12-01', '2016-12-29', '2017-02-14', '2017-03-07', '2017-04-10', '2017-05-09', '2017-06-08', '2017-07-06', '2017-08-08', '2017-09-06', '2017-10-12', '2017-11-03', '2017-12-06', '2018-01-05', '2018-02-07', '2018-03-06', '2018-04-04', '2018-05-07', '2018-06-11', '2018-07-09', '2018-08-08', '2018-09-07', '2018-10-22', '2018-11-05', '2018-12-04', '2019-01-08', '2019-02-19', '2019-03-08', '2019-04-12', '2019-05-09', '2019-06-12', '2019-07-08', '2019-08-09', '2019-09-09', '2019-10-15', '2019-11-12', '2019-12-06', '2020-01-07']], 'AP': [['', 'AP1805', 'AP1810', 'AP1901', 'AP1905', 'AP1910', 'AP2001', 'AP2005'], ['2015-01-05', '2017-12-25', '2018-04-13', '2018-07-13', '2018-11-09', '2019-04-16', '2019-09-16', '2019-12-19']], 'CF': [['CF1505', 'CF1509', 'CF1601', 'CF1605', 'CF1609', 'CF1701', 'CF1705', 'CF1709', 'CF1801', 'CF1805', 'CF1809', 'CF1901', 'CF1905', 'CF1909', 'CF2001', 'CF2005'], ['2015-01-05', '2015-03-23', '2015-07-03', '2015-10-23', '2016-02-04', '2016-06-22', '2016-11-23', '2017-04-05', '2017-08-04', '2017-11-29', '2018-03-27', '2018-05-15', '2018-11-22', '2019-04-04', '2019-08-09', '2019-11-26']], 'CJ': [['', 'CJ1912', 'CJ2001', 'CJ2005'], ['2015-01-05', '2019-05-06', '2019-11-07', '2019-12-04']], 'CY': [['', 'CY1801', 'CY1805', 'CY1809', 'CY1810', 'CY1901', 'CY1905', 'CY2001', 'CY2005'], ['2015-01-05', '2017-08-21', '2017-12-18', '2018-02-07', '2018-05-10', '2018-10-09', '2019-01-03', '2019-04-17', '2019-12-05']], 'FG': [['FG1506', 'FG1509', 'FG1601', 'FG1605', 'FG1609', 'FG1701', 'FG1705', 'FG1709', 'FG1801', 'FG1805', 'FG1809', 'FG1901', 'FG1905', 'FG1909', 'FG2001', 'FG2005'], ['2015-01-05', '2015-04-09', '2015-08-11', '2015-12-03', '2016-04-08', '2016-08-15', '2016-12-06', '2017-04-12', '2017-08-11', '2017-11-30', '2018-04-11', '2018-08-10', '2018-12-14', '2019-04-15', '2019-08-12', '2019-12-11']], 'MA': [['MA1506', 'MA1509', 'MA1601', 'MA1605', 'MA1609', 'MA1701', 'MA1705', 'MA1709', 'MA1801', 'MA1805', 'MA1809', 'MA1901', 'MA1905', 'MA1909', 'MA2001', 'MA2005'], ['2015-01-05', '2015-04-20', '2015-07-28', '2015-12-01', '2016-04-11', '2016-08-10', '2016-12-05', '2017-04-10', '2017-08-08', '2017-12-12', '2018-04-13', '2018-08-10', '2018-12-13', '2019-04-15', '2019-08-19', '2019-12-16']], 'OI': [['OI1505', 'OI1509', 'OI1601', 'OI1605', 'OI1609', 'OI1701', 'OI1705', 'OI1709', 'OI1801', 'OI1805', 'OI1809', 'OI1901', 'OI1905', 'OI1909', 'OI2001', 'OI2005'], ['2015-01-05', '2015-03-11', '2015-06-15', '2015-11-11', '2016-03-09', '2016-07-05', '2016-11-23', '2017-03-16', '2017-07-06', '2017-11-20', '2018-03-22', '2018-07-03', '2018-12-05', '2019-04-03', '2019-08-01', '2019-12-10']], 'PM': [['PM1507', 'PM1509', 'PM1605', 'PM1611', 'PM1701', 'PM1705', 'PM1709', 'PM1711', 'PM1801', 'PM1805', 'PM1811', 'PM1901', 'PM1907', 'PM1911', 'PM2007'], ['2015-01-05', '2015-01-07', '2015-05-22', '2016-04-28', '2016-09-07', '2017-01-05', '2017-04-06', '2017-09-15', '2017-11-15', '2017-12-27', '2018-05-16', '2018-08-07', '2018-11-23', '2019-07-15', '2019-08-28']], 'RI': [['RI1501', 'RI1505', 'RI1601', 'RI1605', 'RI1609', 'RI1703', 'RI1709', 'RI1801', 'RI1807', 'RI1811', 'RI1909', 'RI2005'], ['2015-01-05', '2015-01-06', '2015-03-23', '2016-01-05', '2016-01-22', '2016-05-19', '2016-09-21', '2017-09-06', '2017-11-10', '2018-03-30', '2018-11-15', '2019-09-17']], 'RM': [['RM1505', 'RM1509', 'RM1601', 'RM1605', 'RM1609', 'RM1701', 'RM1705', 'RM1709', 'RM1801', 'RM1805', 'RM1809', 'RM1901', 'RM1905', 'RM1909', 'RM2001', 'RM2005'], ['2015-01-05', '2015-03-04', '2015-07-27', '2015-12-02', '2016-03-15', '2016-08-08', '2016-11-29', '2017-03-21', '2017-08-03', '2017-12-07', '2018-03-28', '2018-07-27', '2018-11-28', '2019-04-02', '2019-08-09', '2019-12-05']], 'RS': [['RS1507', 'RS1509', 'RS1607', 'RS1609', 'RS1611', 'RS1709', 'RS1711', 'RS1807', 'RS1809', 'RS1908', 'RS1909', 'RS1911', 'RS2007'], ['2015-01-05', '2015-05-27', '2015-09-17', '2016-07-15', '2016-09-19', '2016-11-15', '2017-09-15', '2017-10-10', '2018-01-31', '2018-08-31', '2018-12-06', '2019-02-22', '2019-11-15']], 'SA': [['', 'SA2005'], ['2015-01-05', '2019-12-09']], 'SF': [['SF1505', 'SF1509', 'SF1601', 'SF1605', 'SF1609', 'SF1706', 'SF1801', 'SF1802', 'SF1805', 'SF1809', 'SF1901', 'SF1905', 'SF1909', 'SF2001', 'SF2005'], ['2015-01-05', '2015-05-05', '2015-08-11', '2015-12-29', '2016-05-04', '2016-07-12', '2017-02-22', '2017-03-15', '2017-12-18', '2018-04-23', '2018-08-17', '2018-12-25', '2019-04-24', '2019-08-26', '2019-12-24']], 'SM': [['SM1501', 'SM1505', 'SM1601', 'SM1604', 'SM1607', 'SM1609', 'SM1701', 'SM1705', 'SM1709', 'SM1801', 'SM1805', 'SM1809', 'SM1901', 'SM1905', 'SM1909', 'SM2001', 'SM2005'], ['2015-01-05', '2015-01-19', '2015-05-06', '2015-07-02', '2015-07-30', '2016-05-03', '2016-09-01', '2016-12-15', '2017-04-18', '2017-08-14', '2017-12-25', '2018-04-26', '2018-08-16', '2018-12-25', '2019-04-22', '2019-08-21', '2019-12-17']], 'TA': [['TA1505', 'TA1509', 'TA1601', 'TA1605', 'TA1609', 'TA1701', 'TA1705', 'TA1709', 'TA1801', 'TA1805', 'TA1809', 'TA1901', 'TA1905', 'TA1909', 'TA2001', 'TA2005'], ['2015-01-05', '2015-04-01', '2015-08-07', '2015-11-25', '2016-03-31', '2016-08-08', '2016-11-16', '2017-04-10', '2017-08-08', '2017-11-24', '2018-03-28', '2018-08-08', '2018-12-03', '2019-04-10', '2019-08-16', '2019-12-12']], 'UR': [['', 'UR2001', 'UR2005'], ['2015-01-05', '2019-08-12', '2019-12-13']], 'WH': [['WH1501', 'WH1505', 'WH1601', 'WH1605', 'WH1609', 'WH1701', 'WH1705', 'WH1709', 'WH1801', 'WH1805', 'WH1809', 'WH1901', 'WH1905', 'WH1909', 'WH2001', 'WH2003'], ['2015-01-05', '2015-01-19', '2015-05-18', '2015-10-21', '2016-04-19', '2016-07-20', '2016-12-23', '2017-04-27', '2017-07-11', '2017-12-29', '2018-04-17', '2018-07-16', '2018-12-27', '2019-04-26', '2019-09-11', '2020-01-13']], 'ZC': [['', 'ZC1605', 'ZC1609', 'ZC1701', 'ZC1705', 'ZC1709', 'ZC1801', 'ZC1805', 'ZC1809', 'ZC1901', 'ZC1905', 'ZC1909', 'ZC1911', 'ZC2001', 'ZC2005'], ['2015-01-05', '2015-05-19', '2016-04-08', '2016-08-17', '2016-12-07', '2017-04-20', '2017-08-11', '2017-12-21', '2018-04-16', '2018-08-10', '2018-12-07', '2019-04-22', '2019-08-21', '2019-09-17', '2019-12-12']], 'A': [['A1505', 'A1509', 'A1601', 'A1605', 'A1609', 'A1701', 'A1705', 'A1709', 'A1801', 'A1805', 'A1809', 'A1901', 'A1905', 'A1909', 'A2001', 'A2005'], ['2015-01-05', '2015-04-10', '2015-06-17', '2015-11-06', '2016-03-10', '2016-07-15', '2016-11-30', '2017-03-24', '2017-08-07', '2017-12-12', '2018-04-10', '2018-07-31', '2018-12-25', '2019-04-23', '2019-08-13', '2019-12-05']], 'BB': [['BB1502', 'BB1505', 'BB1509', 'BB1511', 'BB1601', 'BB1609', 'BB1701', 'BB1703', 'BB1704', 'BB1705', 'BB1804', 'BB1805', 'BB1809', 'BB1903', 'BB1904', 'BB1910', 'BB2004'], ['2015-01-05', '2015-01-30', '2015-05-05', '2015-09-17', '2015-11-16', '2016-01-18', '2016-06-08', '2017-01-17', '2017-03-15', '2017-04-07', '2017-05-16', '2018-01-16', '2018-05-09', '2018-09-17', '2019-03-05', '2019-03-19', '2019-10-22']], 'B': [['B1505', 'B1509', 'B1511', 'B1601', 'B1605', 'B1701', 'B1703', 'B1705', 'B1709', 'B1805', 'B1809', 'B1901', 'B1905', 'B1906', 'B1907', 'B1908', 'B1909', 'B1910', 'B1911', 'B1912', 'B2001', 'B2002', 'B2003'], ['2015-01-05', '2015-04-10', '2015-09-17', '2015-10-12', '2015-11-23', '2016-02-03', '2016-04-15', '2017-01-06', '2017-03-16', '2017-06-02', '2018-02-22', '2018-07-23', '2018-09-03', '2019-04-08', '2019-05-08', '2019-06-05', '2019-07-02', '2019-08-05', '2019-09-03', '2019-10-10', '2019-11-05', '2019-12-04', '2020-01-06']], 'C': [['C1505', 'C1509', 'C1601', 'C1605', 'C1609', 'C1701', 'C1705', 'C1709', 'C1801', 'C1805', 'C1809', 'C1901', 'C1905', 'C1909', 'C2001', 'C2005'], ['2015-01-05', '2015-01-28', '2015-06-25', '2015-09-09', '2016-02-23', '2016-03-22', '2016-11-15', '2017-03-10', '2017-08-03', '2017-12-06', '2018-03-16', '2018-07-10', '2018-11-15', '2019-03-27', '2019-08-02', '2019-11-28']], 'CS': [['CS1505', 'CS1509', 'CS1601', 'CS1605', 'CS1609', 'CS1701', 'CS1705', 'CS1709', 'CS1801', 'CS1805', 'CS1809', 'CS1901', 'CS1905', 'CS1909', 'CS2001', 'CS2005'], ['2015-01-05', '2015-04-07', '2015-07-29', '2015-10-30', '2016-03-22', '2016-06-29', '2016-11-23', '2017-03-23', '2017-08-09', '2017-12-05', '2018-04-03', '2018-08-08', '2018-12-10', '2019-04-17', '2019-08-26', '2019-12-16']], 'EB': [['', 'EB2005'], ['2015-01-05', '2019-09-27']], 'EG': [['', 'EG1906', 'EG1909', 'EG2001', 'EG2005'], ['2015-01-05', '2018-12-11', '2019-05-06', '2019-08-06', '2019-12-06']], 'JD': [['JD1505', 'JD1509', 'JD1601', 'JD1605', 'JD1609', 'JD1701', 'JD1705', 'JD1709', 'JD1801', 'JD1805', 'JD1809', 'JD1901', 'JD1905', 'JD1909', 'JD2001', 'JD2005'], ['2015-01-05', '2015-03-25', '2015-08-05', '2015-11-27', '2016-03-25', '2016-08-02', '2016-11-30', '2017-04-13', '2017-08-03', '2017-12-04', '2018-04-10', '2018-08-07', '2018-12-10', '2019-04-08', '2019-08-06', '2019-12-03']], 'J': [['J1505', 'J1509', 'J1601', 'J1605', 'J1609', 'J1701', 'J1705', 'J1709', 'J1801', 'J1805', 'J1809', 'J1901', 'J1905', 'J1909', 'J2001', 'J2005'], ['2015-01-05', '2015-03-31', '2015-08-12', '2015-11-26', '2016-03-28', '2016-08-17', '2016-12-05', '2017-04-05', '2017-08-04', '2017-11-30', '2018-04-12', '2018-08-09', '2018-12-07', '2019-04-09', '2019-08-08', '2019-12-12']], 'JM': [['JM1505', 'JM1509', 'JM1601', 'JM1605', 'JM1609', 'JM1701', 'JM1705', 'JM1709', 'JM1801', 'JM1805', 'JM1809', 'JM1901', 'JM1905', 'JM1909', 'JM2001', 'JM2005'], ['2015-01-05', '2015-04-01', '2015-08-11', '2015-11-25', '2016-04-01', '2016-08-16', '2016-12-01', '2017-04-05', '2017-08-07', '2017-12-04', '2018-04-12', '2018-08-09', '2018-12-13', '2019-04-11', '2019-08-20', '2019-12-20']], 'L': [['L1505', 'L1509', 'L1601', 'L1605', 'L1609', 'L1701', 'L1705', 'L1709', 'L1801', 'L1805', 'L1809', 'L1901', 'L1905', 'L1909', 'L2001', 'L2005'], ['2015-01-05', '2015-03-19', '2015-08-05', '2015-11-27', '2016-03-28', '2016-07-26', '2016-11-29', '2017-04-10', '2017-07-31', '2017-11-29', '2018-04-09', '2018-07-31', '2018-11-19', '2019-04-02', '2019-08-02', '2019-12-05']], 'IC': [['', 'IC1505', 'IC1506', 'IC1507', 'IC1508', 'IC1509', 'IC1510', 'IC1511', 'IC1512', 'IC1601', 'IC1602', 'IC1603', 'IC1604', 'IC1605', 'IC1606', 'IC1607', 'IC1608', 'IC1609', 'IC1610', 'IC1611', 'IC1612', 'IC1701', 'IC1702', 'IC1703', 'IC1704', 'IC1705', 'IC1706', 'IC1707', 'IC1708', 'IC1709', 'IC1710', 'IC1711', 'IC1712', 'IC1801', 'IC1802', 'IC1803', 'IC1804', 'IC1805', 'IC1806', 'IC1807', 'IC1809', 'IC1810', 'IC1812', 'IC1901', 'IC1903', 'IC1904', 'IC1905', 'IC1906', 'IC1907', 'IC1908', 'IC1909', 'IC1910', 'IC1912', 'IC2001', 'IC2003'], ['2015-01-05', '2015-04-17', '2015-05-15', '2015-06-19', '2015-07-17', '2015-08-20', '2015-09-21', '2015-10-19', '2015-11-20', '2015-12-21', '2016-01-18', '2016-02-19', '2016-03-21', '2016-04-18', '2016-05-19', '2016-06-20', '2016-07-18', '2016-08-18', '2016-09-19', '2016-10-21', '2016-11-16', '2016-12-16', '2017-01-20', '2017-02-15', '2017-03-17', '2017-04-21', '2017-05-17', '2017-06-16', '2017-07-24', '2017-08-17', '2017-09-18', '2017-10-23', '2017-11-16', '2017-12-15', '2018-01-22', '2018-02-12', '2018-03-19', '2018-04-23', '2018-05-17', '2018-06-15', '2018-07-19', '2018-09-21', '2018-10-17', '2018-12-21', '2019-01-17', '2019-03-18', '2019-04-22', '2019-05-17', '2019-06-24', '2019-07-22', '2019-08-15', '2019-09-23', '2019-10-18', '2019-12-20', '2020-01-15']], 'IF': [['IF1501', 'IF1502', 'IF1503', 'IF1504', 'IF1505', 'IF1506', 'IF1507', 'IF1508', 'IF1509', 'IF1510', 'IF1512', 'IF1601', 'IF1602', 'IF1603', 'IF1604', 'IF1605', 'IF1606', 'IF1607', 'IF1608', 'IF1609', 'IF1610', 'IF1611', 'IF1612', 'IF1701', 'IF1702', 'IF1703', 'IF1704', 'IF1705', 'IF1706', 'IF1707', 'IF1708', 'IF1709', 'IF1710', 'IF1711', 'IF1712', 'IF1801', 'IF1803', 'IF1804', 'IF1805', 'IF1806', 'IF1807', 'IF1808', 'IF1809', 'IF1810', 'IF1812', 'IF1901', 'IF1902', 'IF1903', 'IF1904', 'IF1905', 'IF1906', 'IF1907', 'IF1908', 'IF1909', 'IF1910', 'IF1911', 'IF1912', 'IF2001', 'IF2002'], ['2015-01-05', '2015-01-16', '2015-02-13', '2015-03-20', '2015-04-20', '2015-05-14', '2015-06-19', '2015-07-20', '2015-08-20', '2015-09-21', '2015-10-16', '2015-12-21', '2016-01-18', '2016-02-18', '2016-03-21', '2016-04-18', '2016-05-19', '2016-06-17', '2016-07-15', '2016-08-18', '2016-09-19', '2016-10-21', '2016-11-17', '2016-12-16', '2017-01-20', '2017-02-15', '2017-03-17', '2017-04-21', '2017-05-18', '2017-06-16', '2017-07-24', '2017-08-16', '2017-09-18', '2017-10-23', '2017-11-15', '2017-12-15', '2018-01-19', '2018-03-19', '2018-04-23', '2018-05-17', '2018-06-19', '2018-07-23', '2018-08-15', '2018-09-21', '2018-10-19', '2018-12-24', '2019-01-21', '2019-02-12', '2019-03-18', '2019-04-22', '2019-05-17', '2019-06-24', '2019-07-22', '2019-08-16', '2019-09-23', '2019-10-21', '2019-11-15', '2019-12-23', '2020-01-20']], 'IH': [['', 'IH1505', 'IH1506', 'IH1507', 'IH1508', 'IH1509', 'IH1510', 'IH1512', 'IH1601', 'IH1602', 'IH1603', 'IH1604', 'IH1605', 'IH1606', 'IH1607', 'IH1608', 'IH1609', 'IH1610', 'IH1611', 'IH1612', 'IH1701', 'IH1702', 'IH1703', 'IH1704', 'IH1705', 'IH1706', 'IH1707', 'IH1708', 'IH1709', 'IH1710', 'IH1711', 'IH1712', 'IH1801', 'IH1802', 'IH1803', 'IH1804', 'IH1805', 'IH1806', 'IH1807', 'IH1808', 'IH1809', 'IH1810', 'IH1811', 'IH1812', 'IH1901', 'IH1902', 'IH1903', 'IH1904', 'IH1905', 'IH1906', 'IH1907', 'IH1908', 'IH1909', 'IH1910', 'IH1911', 'IH1912', 'IH2003'], ['2015-01-05', '2015-04-17', '2015-05-15', '2015-06-23', '2015-07-20', '2015-08-21', '2015-09-21', '2015-10-19', '2015-12-18', '2016-01-18', '2016-02-18', '2016-03-21', '2016-04-18', '2016-05-19', '2016-06-17', '2016-07-15', '2016-08-17', '2016-09-19', '2016-10-21', '2016-11-16', '2016-12-16', '2017-01-20', '2017-02-15', '2017-03-17', '2017-04-21', '2017-05-18', '2017-06-16', '2017-07-24', '2017-08-17', '2017-09-18', '2017-10-23', '2017-11-16', '2017-12-18', '2018-01-22', '2018-02-14', '2018-03-19', '2018-04-23', '2018-05-18', '2018-06-19', '2018-07-23', '2018-08-17', '2018-09-25', '2018-10-22', '2018-11-16', '2018-12-24', '2019-01-21', '2019-02-15', '2019-03-18', '2019-04-22', '2019-05-17', '2019-06-24', '2019-07-22', '2019-08-16', '2019-09-23', '2019-10-21', '2019-11-14', '2019-12-20']], 'TF': [['TF1503', 'TF1506', 'TF1509', 'TF1512', 'TF1603', 'TF1606', 'TF1609', 'TF1612', 'TF1703', 'TF1706', 'TF1709', 'TF1712', 'TF1803', 'TF1806', 'TF1809', 'TF1812', 'TF1903', 'TF1906', 'TF1909', 'TF1912', 'TF2003'], ['2015-01-05', '2015-02-05', '2015-05-18', '2015-08-19', '2015-11-19', '2016-02-15', '2016-04-29', '2016-08-12', '2016-11-11', '2017-01-25', '2017-05-12', '2017-08-11', '2017-11-13', '2018-02-13', '2018-05-17', '2018-08-15', '2018-11-20', '2019-02-21', '2019-05-22', '2019-08-14', '2019-11-21']], 'T': [['', 'T1509', 'T1512', 'T1603', 'T1606', 'T1609', 'T1612', 'T1703', 'T1706', 'T1709', 'T1712', 'T1803', 'T1806', 'T1809', 'T1812', 'T1903', 'T1906', 'T1909', 'T1912', 'T2003'], ['2015-01-05', '2015-03-23', '2015-08-14', '2015-11-16', '2016-02-05', '2016-05-06', '2016-08-10', '2016-11-10', '2017-01-19', '2017-05-10', '2017-08-09', '2017-11-10', '2018-02-08', '2018-05-18', '2018-08-15', '2018-11-15', '2019-02-21', '2019-05-21', '2019-08-15', '2019-11-19']], 'TS': [['', 'TS1812', 'TS1903', 'TS1906', 'TS1909', 'TS1912', 'TS2003'], ['2015-01-05', '2018-08-20', '2018-12-03', '2019-03-04', '2019-05-27', '2019-08-20', '2019-11-13']]}
# map_end 这段是定位标志符,不可变更


def update_dominant_future_map(
        code,
        start='2015-01-02',
        end=datetime.datetime.now()
):
    """在线更新jqdata定义的主力合约月份列表,有一些交易不活跃的合约jq的数据也不是很准确
    
    Arguments:
        code {[type]} -- [description]
    
    Keyword Arguments:
        start {str} -- [description] (default: {'2015-01-02'})
        end {[type]} -- [description] (default: {datetime.datetime.now()})
    
    Returns:
        [dict] -- [{'I1705': '2017-03-02',
                    'I1709': '2017-03-23'}] #形如这样的dict,日期是这个这个主力合约的起始日
    """
    code = code.upper()
    days = QA_util_get_trade_range(start, end)
    cons_index = {}

    def init_add(i):
        con = jq.get_dominant_future(code, days[i])
        if con not in cons_index:
            cons_index[con] = [i]
        else:
            cons_index[con].append(i)

    for i in range(0, len(days) - 1, 10):
        init_add(i)

    #避免跳过了最后一日,单独加上
    init_add(len(days) - 1)

    def f(start, end):
        #二分法找con
        ind = (start + end) // 2
        con = jq.get_dominant_future(code, days[ind])
        return con, ind

    cons = list(cons_index.keys())
    for i in range(1, len(cons)):
        start = max(cons_index[cons[i - 1]])
        end = min(cons_index[cons[i]])
        while start + 1 != end: #如果没有找到相邻con的分界点就不停找
            con, ind = f(start, end)
            cons_index[con].append(ind)
            start = max(cons_index[cons[i - 1]])
            end = min(cons_index[cons[i]])
    for i in cons:
        start = days[min(cons_index[i])]
        cons_index[i] = start

    return [
        [x.split('.')[0] for x in list(cons_index.keys())],
        list(cons_index.values())
    ]


def save_dominant_future_map(code, res):
    future_map[code] = res

    abs_path = os.path.abspath(os.path.dirname(__file__)) + '/QAFutureMap.py'
    #content = '0'
    with open(abs_path, 'r') as file:
        content = file.read()
        start = content.index('future_map')
        end = content.index('# map_end')
        last_map = content[content.index('{'):content.index('map_end')]
        content = content.replace(last_map, str(future_map) + '\n# ')

    with open(abs_path, 'w') as file:
        file.write(content)


def get_dominant_future_map(code, start=None, end=None, update=False):
    """获取主力合约对应的月合约名,返回月合约名及对应的起始日期,
    如果指定start或者end,则返回这段时间对应的主力合约分界

    Arguments:
        code {[type]} -- [description]
    
    Keyword Arguments:
        start {[type]} -- [指定的开始日期] (default: {None})
        end {[type]} -- [指定的结束日期] (default: {None})
        update {bool} -- [是否更新] (default: {False})
    
    Returns:
        [[contracts,start_dates]] -- [[月合约名,对应的起始日]]
    """
    code = code.upper()
    if code not in future_map or update:
        res = update_dominant_future_map(code)
        future_map[code] = res
        save_dominant_future_map(code, res)
    [cons, days] = copy.deepcopy(future_map[code])

    if start is not None:
        for i in range(1, len(days)):
            if start >= days[i - 1] and start < days[i]:
                days[i - 1] = start
                days, cons = days[i - 1:], cons[i - 1:]
                break

    if end is not None:
        for i in range(1, len(days)):
            if end >= days[i - 1] and end < days[i]:
                days, cons = days[:i], cons[:i]
                break

    return [cons, days]


def get_dominant_future_by_day(code, day):
    """返回输入日期day对应的合约主力合约月份
    
    Arguments:
        code {[type]} -- [description]
        day {[type]} -- [description]
    """
    [cons, days] = get_dominant_future_map(code)
    res = 0
    for i in range(-1, -len(days) - 1, -1):
        if day > days[i]:
            res = cons[days.index(days[i])]
            break
    return res
